# 自动化部署脚本

<cite>
**本文引用的文件**
- [ops/deploy.sh](file://ops/deploy.sh)
- [ops/generate-secrets.sh](file://ops/generate-secrets.sh)
- [ops/rollback.sh](file://ops/rollback.sh)
- [ops/docker/init-cert.sh](file://ops/docker/init-cert.sh)
- [ops/docker/certbot-renew.sh](file://ops/docker/certbot-renew.sh)
- [ops/docker/docker-compose.prod.yml](file://ops/docker/docker-compose.prod.yml)
- [ops/docker/docker-compose.dev.yml](file://ops/docker/docker-compose.dev.yml)
- [ops/docker/Dockerfile.backend](file://ops/docker/Dockerfile.backend)
- [ops/docker/Dockerfile.frontend](file://ops/docker/Dockerfile.frontend)
- [ops/nginx/nginx.conf](file://ops/nginx/nginx.conf)
- [ops/nginx/sites.conf](file://ops/nginx/sites.conf)
- [ops/backups/backup.sh](file://ops/backups/backup.sh)
- [ops/backups/restore.sh](file://ops/backups/restore.sh)
- [ops/backups/retention.sh](file://ops/backups/retention.sh)
</cite>

## 更新摘要
**所做更改**
- 新增完整的回滚脚本功能，支持基于 Git 引用的版本回滚
- 完善证书初始化和续期脚本，实现自动化证书管理
- 增强部署脚本的错误处理和健康检查机制
- 优化备份和恢复脚本，提供更完善的灾难恢复能力
- 更新 Docker Compose 配置，增强服务间依赖管理和健康检查

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)
10. [附录](#附录)

## 简介
本文件面向运维团队，系统化梳理并说明项目的自动化部署脚本与流程，覆盖生产环境与开发环境的部署步骤、脚本使用方法、镜像拉取、容器停止、服务启动、健康检查验证、证书初始化与自动续期机制、定时任务配置、参数说明、错误处理与故障排除，以及最佳实践建议。读者无需深入编程背景即可按步骤完成部署与维护。

## 项目结构
项目采用前后端分离与环境隔离的设计，生产环境通过 Docker Compose 编排 Nginx、前端、后端与 PostgreSQL，并集成 Let's Encrypt 自动化证书管理；开发环境使用 SQLite，支持热重载与快速启动。

```mermaid
graph TB
subgraph "开发环境"
FE_DEV["前端(Next.js)<br/>:3000"]
BE_DEV["后端(Strapi)<br/>:1337"]
DEV_COMP["开发容器编排(dev.yml)"]
FE_DEV --> BE_DEV
BE_DEV --> DEV_COMP
end
subgraph "生产环境"
NGINX["Nginx(反向代理)<br/>:80/:443"]
FE_PROD["前端(Next.js)<br/>:3000"]
BE_PROD["后端(Strapi)<br/>:1337"]
PG["PostgreSQL<br/>:5432"]
CERT["Certbot(Let's Encrypt)"]
PROD_COMP["生产容器编排(prod.yml)"]
NGINX --> FE_PROD
NGINX --> BE_PROD
FE_PROD --> PG
BE_PROD --> PG
NGINX --> CERT
CERT --> PROD_COMP
end
```

**图表来源**
- [ops/docker/docker-compose.dev.yml](file://ops/docker/docker-compose.dev.yml#L1-L55)
- [ops/docker/docker-compose.prod.yml](file://ops/docker/docker-compose.prod.yml#L1-L153)

**章节来源**
- [ops/docker/docker-compose.dev.yml](file://ops/docker/docker-compose.dev.yml#L1-L55)
- [ops/docker/docker-compose.prod.yml](file://ops/docker/docker-compose.prod.yml#L1-L153)

## 核心组件
- **密钥生成脚本**：自动生成生产环境所需的敏感变量并写入环境文件，供部署脚本与容器编排使用。
- **生产环境部署脚本**：负责拉取最新镜像、停止旧容器、启动基础服务、检查证书、启动 Nginx/Certbot 并进行健康检查。
- **回滚脚本**：支持基于 Git 引用的版本回滚，实现快速故障恢复。
- **开发环境启动脚本**：一键启动开发环境（前端+后端+SQLite），支持热重载。
- **证书初始化与续期脚本**：首次部署时初始化证书，后续由定时任务自动续期并重载 Nginx。
- **备份与恢复脚本**：提供数据库与媒体文件的备份、恢复与保留策略。
- **健康检查与日志管理**：容器健康检查配置与日志轮转策略，便于监控与排障。

**章节来源**
- [ops/deploy.sh](file://ops/deploy.sh#L1-L61)
- [ops/generate-secrets.sh](file://ops/generate-secrets.sh#L1-L74)
- [ops/rollback.sh](file://ops/rollback.sh#L1-L53)

## 架构总览
下图展示生产环境的自动化部署流程与关键交互：

```mermaid
sequenceDiagram
participant Ops as "运维人员"
participant SecretGen as "密钥生成脚本"
participant Deploy as "部署脚本"
participant Rollback as "回滚脚本"
participant Docker as "Docker Compose"
participant Postgres as "PostgreSQL"
participant Backend as "Strapi 后端"
participant Frontend as "Next.js 前端"
participant Nginx as "Nginx"
participant Certbot as "Certbot"
Ops->>SecretGen : 生成生产环境密钥
SecretGen-->>Ops : 输出.env.prod文件
Ops->>Deploy : 执行部署脚本
Deploy->>Docker : 构建镜像
Deploy->>Docker : 停止旧容器
Deploy->>Docker : 启动基础服务
Deploy->>Docker : 检查证书状态
Deploy->>Docker : 启动 Nginx 与 Certbot
Deploy->>Nginx : 健康检查
Deploy->>Backend : 健康检查
Ops->>Rollback : 执行回滚操作
Rollback->>Docker : 检出目标版本
Rollback->>Docker : 重新构建镜像
Rollback->>Docker : 启动服务
Rollback->>Nginx : 健康检查
Rollback->>Backend : 健康检查
```

**图表来源**
- [ops/deploy.sh](file://ops/deploy.sh#L16-L61)
- [ops/rollback.sh](file://ops/rollback.sh#L21-L53)

**章节来源**
- [ops/deploy.sh](file://ops/deploy.sh#L1-L61)
- [ops/rollback.sh](file://ops/rollback.sh#L1-L53)

## 详细组件分析

### 密钥生成脚本
- **功能**：生成生产环境所需的一组随机密钥（含数据库密码、应用密钥、JWT 密钥等），并写入生产环境变量文件。
- **输入**：域名、邮箱（用于 Let's Encrypt）。
- **输出**：生产环境变量文件，包含数据库与应用密钥等。
- **安全要点**：生成的密钥不提交至代码仓库，部署前务必手动替换 Nginx 配置中的域名。

```mermaid
flowchart TD
Start(["开始"]) --> CheckDomain["检查域名参数"]
CheckDomain --> InputDomain["用户输入域名"]
InputDomain --> CheckEmail["检查邮箱参数"]
CheckEmail --> InputEmail["用户输入邮箱"]
InputEmail --> GenerateKeys["生成8个随机密钥"]
GenerateKeys --> CreateEnv["创建.env.prod文件"]
CreateEnv --> BackupOld["备份旧环境文件"]
BackupOld --> WriteEnv["写入新环境变量"]
WriteEnv --> Success(["生成完成"])
```

**图表来源**
- [ops/generate-secrets.sh](file://ops/generate-secrets.sh#L7-L74)

**章节来源**
- [ops/generate-secrets.sh](file://ops/generate-secrets.sh#L1-L74)

### 生产环境部署脚本
- **功能**：自动化完成镜像构建、容器停止、基础服务启动、证书检查、Nginx/Certbot 启动与健康检查。
- **关键步骤**：
  - 构建镜像
  - 停止旧容器
  - 启动 postgres、backend、frontend
  - 等待服务就绪
  - 检查证书是否存在
  - 启动 nginx 与 certbot
  - 健康检查（前端与后端）
- **参数**：无显式命令行参数，依赖环境变量文件与容器编排文件。

```mermaid
flowchart TD
DStart(["开始"]) --> CheckEnv["检查.env.prod文件"]
CheckEnv --> BuildImages["构建Docker镜像"]
BuildImages --> StopOld["停止旧容器"]
StopOld --> StartBase["启动基础服务"]
StartBase --> WaitReady["等待服务就绪"]
WaitReady --> CheckCert["检查证书状态"]
CheckCert --> |不存在| PromptInit["提示初始化证书"]
CheckCert --> |存在| StartProxy["启动Nginx与Certbot"]
StartProxy --> HealthCheck["执行健康检查"]
HealthCheck --> Success["部署完成"]
PromptInit --> Error(["部署失败"])
```

**图表来源**
- [ops/deploy.sh](file://ops/deploy.sh#L16-L61)

**章节来源**
- [ops/deploy.sh](file://ops/deploy.sh#L1-L61)

### 回滚脚本
- **功能**：支持基于 Git 引用的版本回滚，实现快速故障恢复。
- **关键步骤**：
  - 检查目标 Git 引用
  - 获取所有远程分支
  - 切换到指定版本
  - 重新构建镜像
  - 启动服务
  - 健康检查
- **使用场景**：当新版本出现严重问题时，快速回滚到稳定版本。

```mermaid
flowchart TD
RStart(["开始回滚"]) --> CheckRef["检查Git引用参数"]
CheckRef --> FetchBranches["获取远程分支"]
FetchBranches --> Checkout["切换到目标版本"]
Checkout --> Rebuild["重新构建镜像"]
Rebuild --> StartServices["启动所有服务"]
StartServices --> HealthCheck["执行健康检查"]
HealthCheck --> Success["回滚完成"]
```

**图表来源**
- [ops/rollback.sh](file://ops/rollback.sh#L8-L53)

**章节来源**
- [ops/rollback.sh](file://ops/rollback.sh#L1-L53)

### 证书初始化与自动续期
- **证书初始化**：首次部署时通过 Certbot standalone 模式获取证书，支持多域名配置。
- **自动续期**：通过定时任务每日检查并续期，成功后自动重载 Nginx。
- **配置要点**：Nginx 配置允许 ACME 挑战路径，生产站点启用安全头与 TLS 参数。

```mermaid
flowchart TD
CStart(["证书管理"]) --> InitCert["初始化证书"]
InitCert --> CheckDomains["检查域名列表"]
CheckDomains --> RequestCert["请求Let's Encrypt证书"]
RequestCert --> StoreCert["存储证书到卷"]
StoreCert --> SetupCron["设置定时续期任务"]
SetupCron --> DailyRenew["每日续期检查"]
DailyRenew --> AutoReload["自动重载Nginx"]
AutoReload --> Complete(["证书管理完成"])
```

**图表来源**
- [ops/docker/init-cert.sh](file://ops/docker/init-cert.sh#L14-L31)
- [ops/docker/certbot-renew.sh](file://ops/docker/certbot-renew.sh#L4-L6)

**章节来源**
- [ops/docker/init-cert.sh](file://ops/docker/init-cert.sh#L1-L31)
- [ops/docker/certbot-renew.sh](file://ops/docker/certbot-renew.sh#L1-L7)

### 备份与恢复
- **备份策略**：数据库与媒体文件分别备份，支持自定义保留策略。
- **备份脚本**：支持环境变量配置，生成 SQL 与压缩的媒体归档。
- **恢复脚本**：从备份文件恢复数据库和媒体文件。
- **保留策略**：自动清理超过指定天数的备份文件。

```mermaid
flowchart TD
BStart(["备份管理"]) --> Config["配置备份参数"]
Config --> BackupDB["备份数据库"]
BackupDB --> BackupMedia["备份媒体文件"]
BackupMedia --> Compress["压缩备份文件"]
Compress --> Store["存储到备份目录"]
Store --> Schedule["设置定时任务"]
Schedule --> Restore["执行恢复操作"]
Restore --> Clean["清理过期备份"]
Clean --> BComplete(["备份完成"])
```

**图表来源**
- [ops/backups/backup.sh](file://ops/backups/backup.sh#L14-L33)
- [ops/backups/restore.sh](file://ops/backups/restore.sh#L19-L31)
- [ops/backups/retention.sh](file://ops/backups/retention.sh#L12-L16)

**章节来源**
- [ops/backups/backup.sh](file://ops/backups/backup.sh#L1-L33)
- [ops/backups/restore.sh](file://ops/backups/restore.sh#L1-L31)
- [ops/backups/retention.sh](file://ops/backups/retention.sh#L1-L16)

### 健康检查与日志管理
- **健康检查**：容器层面配置健康检查命令，定期探测服务可用性。
- **日志管理**：Docker 日志驱动与轮转策略，支持查看与追踪日志。
- **监控指标**：CPU、内存、磁盘、响应时间、API 错误率、证书有效期等。

**章节来源**
- [ops/docker/docker-compose.prod.yml](file://ops/docker/docker-compose.prod.yml#L18-L28)
- [ops/docker/docker-compose.prod.yml](file://ops/docker/docker-compose.prod.yml#L48-L58)
- [ops/docker/docker-compose.prod.yml](file://ops/docker/docker-compose.prod.yml#L111-L122)

## 依赖关系分析
- **环境变量与配置**：
  - 生产环境变量文件包含数据库、应用密钥、域名与 Let's Encrypt 邮箱等。
  - 后端数据库配置支持 sqlite、postgres、mysql，生产环境使用 postgres。
- **容器编排**：
  - Docker Compose 编排 Nginx、前端、后端、PostgreSQL、Certbot。
- **脚本依赖**：
  - 部署脚本依赖环境变量文件与 Docker Compose 配置。
  - 证书脚本依赖域名与邮箱环境变量。

```mermaid
graph LR
Env[".env.prod(生产环境变量)"] --> Deploy["部署脚本"]
Env --> Rollback["回滚脚本"]
Env --> Backup["备份脚本"]
Env --> CertInit["证书初始化脚本"]
Deploy --> ComposeProd["生产Docker Compose"]
Rollback --> Git["Git版本控制"]
Backup --> Storage["备份存储"]
CertInit --> Certbot["Certbot服务"]
ComposeProd --> Nginx["Nginx"]
ComposeProd --> Frontend["前端"]
ComposeProd --> Backend["后端"]
ComposeProd --> Postgres["PostgreSQL"]
```

**图表来源**
- [ops/deploy.sh](file://ops/deploy.sh#L4-L6)
- [ops/rollback.sh](file://ops/rollback.sh#L4-L6)
- [ops/docker/docker-compose.prod.yml](file://ops/docker/docker-compose.prod.yml#L1-L153)

**章节来源**
- [ops/deploy.sh](file://ops/deploy.sh#L1-L61)
- [ops/rollback.sh](file://ops/rollback.sh#L1-L53)
- [ops/docker/docker-compose.prod.yml](file://ops/docker/docker-compose.prod.yml#L1-L153)

## 性能考虑
- **构建策略**：采用"部署时构建"与多阶段构建，减小镜像体积并提升安全性。
- **构建缓存**：利用 Docker 层缓存加速构建。
- **资源限制**：建议为各服务设置合理的资源限制与健康检查，避免资源争抢。
- **网络隔离**：生产环境通过 Nginx 单一入口，隐藏后端服务，降低攻击面。

**章节来源**
- [ops/docker/Dockerfile.backend](file://ops/docker/Dockerfile.backend#L1-L38)
- [ops/docker/Dockerfile.frontend](file://ops/docker/Dockerfile.frontend#L1-L39)
- [ops/docker/docker-compose.prod.yml](file://ops/docker/docker-compose.prod.yml#L7-L10)

## 故障排除指南
- **证书相关**
  - 症状：访问 HTTPS 返回证书错误或 404。
  - 排查：确认证书卷挂载、Nginx SSL 配置与 ACME 挑战路径。
  - 处理：重新初始化证书或检查定时续期任务。
- **数据库连接**
  - 症状：后端无法连接数据库。
  - 排查：确认 PostgreSQL 已启动、网络连通、凭据正确。
- **健康检查失败**
  - 症状：容器健康检查失败。
  - 排查：查看容器日志，确认服务监听端口与健康检查命令。
- **部署脚本错误**
  - 症状：脚本报错或中断。
  - 排查：检查环境变量文件是否存在、Docker Compose 文件路径与权限、镜像拉取权限。
- **回滚失败**
  - 症状：回滚后服务不可用。
  - 排查：确认目标版本存在、依赖包完整、环境变量正确。

**章节来源**
- [ops/deploy.sh](file://ops/deploy.sh#L8-L12)
- [ops/rollback.sh](file://ops/rollback.sh#L14-L17)

## 结论
该自动化部署方案通过脚本化与容器化实现了生产与开发环境的清晰分离，配合健康检查、证书自动化与备份策略，显著降低了运维复杂度与人为错误风险。新增的回滚功能提供了完整的灾难恢复能力，确保系统在出现问题时能够快速恢复。建议在生产环境中严格执行密钥与配置管理、定期巡检与演练回滚流程，以保障系统的高可用与可维护性。

## 附录

### 使用示例与最佳实践
- **首次部署（生产）**
  - 生成密钥并写入环境变量文件：`./ops/generate-secrets.sh szczk.com`
  - 替换 Nginx 配置中的域名。
  - 初始化证书：`docker compose -f ops/docker/docker-compose.prod.yml run --rm certbot /opt/init-cert.sh`
  - 启动服务：`./ops/deploy.sh`
  - 执行健康检查，确认服务可用。
- **更新部署（生产）**
  - 直接运行部署脚本：`./ops/deploy.sh`
  - 如需强制重建，添加 `--no-cache` 参数。
- **版本回滚**
  - 查看可用版本：`git tag`
  - 回滚到指定版本：`./ops/rollback.sh <git-tag>`
  - 支持回滚到任何历史版本。
- **开发环境**
  - 直接运行开发启动脚本：`docker compose -f ops/docker/docker-compose.dev.yml up -d`
  - 访问前端与后端服务。
- **备份与恢复**
  - 配置定时任务，定期执行备份与清理。
  - 发生故障时，使用恢复脚本从备份恢复数据库和媒体文件。

**章节来源**
- [ops/deploy.sh](file://ops/deploy.sh#L16-L61)
- [ops/rollback.sh](file://ops/rollback.sh#L21-L53)
- [ops/backups/backup.sh](file://ops/backups/backup.sh#L14-L33)

### 脚本参数与环境变量说明
- **密钥生成脚本**
  - 输入：域名、Let's Encrypt 邮箱。
  - 输出：生产环境变量文件 `.env.prod`。
- **部署脚本**
  - 依赖：生产环境变量文件、Docker Compose 配置。
  - 行为：构建镜像、停止旧容器、启动基础服务、检查证书、启动代理与证书服务、健康检查。
- **回滚脚本**
  - 输入：Git 引用（标签、分支或提交哈希）。
  - 行为：检出目标版本、重新构建镜像、启动服务、健康检查。
- **证书脚本**
  - 输入：域名列表、Let's Encrypt 邮箱。
  - 行为：获取/续期证书并重载 Nginx。
- **备份脚本**
  - 输入：数据库连接参数、备份目录、保留天数。
  - 行为：导出数据库与打包媒体文件。

**章节来源**
- [ops/generate-secrets.sh](file://ops/generate-secrets.sh#L7-L74)
- [ops/deploy.sh](file://ops/deploy.sh#L42-L56)
- [ops/rollback.sh](file://ops/rollback.sh#L8-L36)
- [ops/docker/init-cert.sh](file://ops/docker/init-cert.sh#L4-L12)
- [ops/backups/backup.sh](file://ops/backups/backup.sh#L4-L12)

### Docker 配置详解
- **生产环境配置**
  - PostgreSQL：1GB 内存限制，健康检查，数据持久化。
  - 后端：Node.js 24，生产模式，健康检查。
  - 前端：Next.js，静态文件优化，健康检查。
  - Nginx：1.27 版本，SSL 配置，安全头。
  - Certbot：证书管理，自动续期。
- **开发环境配置**
  - 后端：开发模式，热重载，端口映射。
  - 前端：开发模式，TurboPack，端口映射。
  - 卷挂载：代码热更新，依赖缓存。

**章节来源**
- [ops/docker/docker-compose.prod.yml](file://ops/docker/docker-compose.prod.yml#L3-L153)
- [ops/docker/docker-compose.dev.yml](file://ops/docker/docker-compose.dev.yml#L1-L55)
- [ops/nginx/sites.conf](file://ops/nginx/sites.conf#L1-L63)

### 安全配置要点
- **证书安全**
  - 使用 Let's Encrypt 免费证书。
  - 启用 HSTS、X-Frame-Options、X-Content-Type-Options 等安全头。
  - 支持多域名证书。
- **访问控制**
  - Nginx 配置 ACME 挑战路径。
  - 后端 API 限流与防护。
  - 数据库连接加密。
- **密钥管理**
  - 环境变量文件权限设置。
  - 秘钥定期轮换。
  - 最小权限原则。

**章节来源**
- [ops/nginx/sites.conf](file://ops/nginx/sites.conf#L21-L30)
- [ops/docker/init-cert.sh](file://ops/docker/init-cert.sh#L28-L31)
- [ops/generate-secrets.sh](file://ops/generate-secrets.sh#L32-L71)